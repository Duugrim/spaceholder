# Масштабирование размера целей на основе DEX

## Описание

Система масштабирования целей автоматически изменяет эффективный размер цели (радиус для сэмплирования точек попадания) на основе характеристики DEX (Dexterity) токена.

## Формула

```
Множитель размера = DEX / 10
Эффективный радиус = Базовый радиус токена × Множитель размера
```

## Примеры

| DEX | Множитель | Эффект |
|-----|-----------|--------|
| 5   | 0.5       | Цель в 2 раза меньше (сложнее попасть) |
| 10  | 1.0       | Стандартный размер цели |
| 15  | 1.5       | Цель в 1.5 раза больше (легче попасть) |
| 20  | 2.0       | Цель в 2 раза больше (очень легко попасть) |

## Технические детали

### Где применяется

Множитель применяется в следующих методах `shot-manager.mjs`:

1. **`_isHitLine`** - проверка попадания линейного выстрела (луч, пуля)
2. **`_calculateCircleTokenCoverage`** - расчёт покрытия токена круговым AOE
3. **`_calculateConeTokenCoverage`** - расчёт покрытия токена конусным AOE

### Реализация

Добавлен вспомогательный метод `_getTargetSizeMultiplier(token)`:

```javascript
_getTargetSizeMultiplier(token) {
  if (!token || !token.actor) return 1.0;
  
  const dex = token.actor.system?.abilities?.dex?.value;
  if (typeof dex !== 'number' || dex <= 0) return 1.0;
  
  return dex / 10;
}
```

### Затронутые параметры

При расчёте попаданий модифицируется:
- **effectiveRadius** - эффективный радиус цели
- Используется вместо базового `tokenRadius` при:
  - Проверке пересечения линейного луча с целью
  - Быстрой проверке попадания в AOE
  - Размещении точек сэмплирования по кольцам

#### Важно: Линия обзора (LoS)

Метод `_checkLineOfSight` **не** использует масштабирование. Это логично, т.к.:
- DEX влияет на **сложность попадания** по токену (ловкость, увороты)
- Но **физический размер** токена как препятствия остаётся неизменным

### Обратная совместимость

- Если у токена нет актора: множитель = 1.0
- Если DEX не определён или ≤ 0: множитель = 1.0
- Существующие системы продолжают работать без изменений

## Тестирование

Для тестирования используйте скрипт `test-target-size-scaling.js`:

1. Выберите токен на сцене
2. Запустите скрипт в консоли браузера
3. Проверьте вывод DEX и вычисленный множитель

## Будущие улучшения

В дальнейшем планируется добавить более сложную логику:
- Дополнительные модификаторы (размер токена, эффекты)
- Настройки сложности попадания
- Зависимость от типа атаки
- Влияние других характеристик (PER для точности стрельбы)

## Changelog

- **2025-01-05**: Первая версия
  - Базовое масштабирование на основе DEX/10
  - Реализовано для AOE (круг и конус)
  - Добавлено для линейных выстрелов
