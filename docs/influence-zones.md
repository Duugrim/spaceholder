# Система сфер влияния (Influence Zones)

## Обзор

Система сфер влияния позволяет создавать глобальные объекты с зонами контроля, которые визуализируются на карте. Объекты одной стороны объединяют свои зоны, создавая общую территорию влияния (как в Stellaris).

## Proof of Concept (v1)

Текущая версия — базовый PoC с простой визуализацией через наложение полупрозрачных кругов.

## Типы акторов

### Global Object

Новый тип актора для представления объектов со сферами влияния.

**Параметры:**
- `gRange` (number) — радиус сферы влияния в **клетках** (по умолчанию: 0). Может быть дробным.
- `gPower` (number) — сила влияния, определяет приоритет при столкновениях (по умолчанию: 0)
- `gFaction` (string) — UUID Journal (JournalEntry/JournalEntryPage) фракции; объекты одной фракции объединяются

> Примечание: в старых версиях `gRange` хранился в формате “клетки×100”. Сейчас `gRange` — это напрямую клетки.
> Если у тебя есть старые Global Object'ы, приведи значение вручную (раздели на 100).

## Использование

### Создание Global Object

1. Создайте нового актора через Actors Directory
2. Выберите тип: **Global Object**
3. Настройте параметры:
   - **Range** — радиус влияния (в клетках)
   - **Power** — сила (для будущих механик столкновений)
   - **Faction** — UUID Journal фракции (JournalEntry/JournalEntryPage)

### Размещение на сцене

1. Перетащите Global Object на сцену как обычный токен
2. Разместите несколько объектов с разными параметрами
3. Объекты с одинаковым `gFaction` будут визуально объединяться

### Визуализация зон влияния

**Показать зоны:**
```js
game.spaceholder.showInfluence()
```

**Скрыть зоны:**
```js
game.spaceholder.hideInfluence()
```

Или через консоль:
```js
// Прямой доступ к менеджеру
game.spaceholder.influenceManager.drawInfluenceZones()
game.spaceholder.influenceManager.clearAll()
```

## Цвета

- Цвет берётся из папки Journal фракции (если задан цвет папки)
- Иначе используется детерминированный fallback-цвет

## Визуальное поведение

- **Одна сторона:** круги одной стороны накладываются друг на друга, создавая эффект объединённой территории
- **Разные стороны:** каждая сторона имеет свой цвет, области могут пересекаться

## Технические детали

### InfluenceManager

Класс `InfluenceManager` управляет визуализацией:

**Методы:**
- `initialize()` — инициализация контейнера PIXI
- `collectGlobalObjects()` — сбор всех Global Objects на сцене
- `drawInfluenceZones()` — отрисовка зон влияния
- `clearAll()` — очистка всей графики
- `destroy()` — полное уничтожение менеджера

**Доступ:**
```js
game.spaceholder.influenceManager
```

### Структура данных

Global Objects на сцене собираются в массив:
```js
{
  token: Token,
  gRange: number, // радиус в пикселях (system.gRange * grid.size)
  gPower: number,
  gFaction: string,
  position: {x: number, y: number}
}
```

## Планы развития

### v2: Настоящее объединение геометрии
- Использование библиотеки вычислительной геометрии (martinez-polygon-clipping или polybooljs)
- Точное объединение (union) кругов одной стороны в один контур
- Вычитание (subtract) областей разных сторон

### v3: Механики столкновений
- Использование `gPower` для определения границы между фракциями
- Визуализация "линии фронта" между враждебными сторонами
- Смещение границы в сторону более слабой фракции

### v4: Динамическое обновление
- Автоматический пересчёт при движении токенов
- Анимации изменения границ
- Оптимизация производительности для большого количества объектов

## Примеры использования

### Пример 1: Две враждующие фракции
```js
// Создайте 3-4 Global Objects с gFaction=<UUID Journal фракции> и gRange=5
// Создайте 3-4 Global Objects с gFaction=<UUID другой фракции> и gRange=5
// Разместите их на карте группами
game.spaceholder.showInfluence()
// Вы увидите две цветные территории
```

### Пример 2: Три фракции
```js
// Создайте Global Objects с разными gFaction: <UUID 1>, <UUID 2>, <UUID 3>
// Каждая получит свой цвет
game.spaceholder.showInfluence()
```

## Troubleshooting

**Зоны не отображаются:**
- Проверьте, что на сцене есть токены с типом актора `globalobject`
- Убедитесь, что `gRange > 0`
- Проверьте консоль на наличие ошибок

**Цвет не тот, что ожидался:**
- Проверьте корректность UUID в `gFaction`
- Проверьте цвет папки Journal фракции

**Производительность:**
- Текущая версия рисует отдельные круги для каждого объекта
- При большом количестве объектов (>100) возможны задержки
- Планируется оптимизация в будущих версиях
