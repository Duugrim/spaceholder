<form class="{{cssClass}} {{actor.type}} flexcol" autocomplete="off" data-faction="{{system.gFaction}}" {{#if factionColor}}style="--faction-color: {{factionColor}};"{{/if}}>

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    <div class="header-fields">
      <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Name"/></h1>

      {{!-- Фракция под именем актёра (вернули в хедер) --}}
      <div class="form-group globalobject-faction">
        <label for="system.gFaction">Фракция</label>
        <div class="form-fields">
          {{#if system.gFaction}}
            <input type="hidden" name="system.gFaction" value="{{system.gFaction}}"/>
            <a class="content-link" data-action="uuid-open" data-uuid="{{system.gFaction}}">
              <span
                class="faction-color-swatch"
                title="{{factionColor}}"
                aria-hidden="true"
                {{#if factionColor}}style="--faction-color: {{factionColor}};"{{/if}}
              ></span>
              {{gFactionName}}
            </a>
            <button type="button" class="icon-btn" data-action="uuid-clear" data-field="system.gFaction">
              <i class="fa-solid fa-xmark"></i>
            </button>
          {{else}}
            <input
              type="text"
              name="system.gFaction"
              value="{{system.gFaction}}"
              placeholder="UUID фракции"
              data-action="uuid-drop"
              data-field="system.gFaction"
            />
          {{/if}}
        </div>
      </div>

      {{!-- Кнопки актора/токена (в хедере) --}}
      <div class="actor-buttons">
        {{!-- Привязка данных актёра (actorLink) --}}
        <div class="actor-linkdata-buttons" role="group" aria-label="Привязка данных актёра">
          <button
            type="button"
            class="icon-btn actorlink-btn {{#if tokenActorLink}}is-active{{/if}}"
            data-action="token-actorlink-toggle"
            data-tooltip="Привязка данных актёра"
            aria-label="Привязка данных актёра"
            {{#unless canToggleActorLink}}disabled{{/unless}}
          ><i class="fa-solid {{#if tokenActorLink}}fa-link{{else}}fa-link-slash{{/if}}"></i></button>
        </div>

        {{!-- Видимость --}}
        <div class="token-visibility-buttons" role="group" aria-label="Видимость">
          <input type="hidden" name="flags.spaceholder.tokenVisibility" value="{{flags.spaceholder.tokenVisibility}}" />

          <button
            type="button"
            class="icon-btn visibility-btn {{#if (eq flags.spaceholder.tokenVisibility "public")}}is-active{{/if}}"
            data-action="token-visibility-set"
            data-value="public"
            data-tooltip="Публичный (обычный)"
            aria-label="Публичный (обычный)"
            {{#unless editable}}disabled{{/unless}}
          ><i class="fa-solid fa-user"></i></button>

          <button
            type="button"
            class="icon-btn visibility-btn {{#if (eq flags.spaceholder.tokenVisibility "halfHidden")}}is-active{{/if}}"
            data-action="token-visibility-set"
            data-value="halfHidden"
            data-tooltip="HalfHidden (виден всем в чужой зоне)"
            aria-label="HalfHidden (виден всем в чужой зоне)"
            {{#unless editable}}disabled{{/unless}}
          ><i class="fa-solid fa-user-magnifying-glass"></i></button>

          <button
            type="button"
            class="icon-btn visibility-btn {{#if (eq flags.spaceholder.tokenVisibility "fullHidden")}}is-active{{/if}}"
            data-action="token-visibility-set"
            data-value="fullHidden"
            data-tooltip="FullHidden (виден владельцу зоны)"
            aria-label="FullHidden (виден владельцу зоны)"
            {{#unless editable}}disabled{{/unless}}
          ><i class="fa-solid fa-user-lock"></i></button>

          <button
            type="button"
            class="icon-btn visibility-btn {{#if (eq flags.spaceholder.tokenVisibility "secret")}}is-active{{/if}}"
            data-action="token-visibility-set"
            data-value="secret"
            data-tooltip="Секретный"
            aria-label="Секретный"
            {{#unless editable}}disabled{{/unless}}
          ><i class="fa-solid fa-user-secret"></i></button>
        </div>
      </div>
    </div>
  </header>

  {{!-- Sheet Body (no tabs) --}}
  <section class="sheet-body">

    {{!-- Ссылка --}}
    <div class="form-group">
      <label for="system.gLink">Ссылка</label>
      <div class="form-fields">
        {{#if system.gLink}}
          <input type="hidden" name="system.gLink" value="{{system.gLink}}"/>
          <a class="content-link" data-action="uuid-open" data-uuid="{{system.gLink}}">
            <i class="fa-solid fa-book-open"></i> {{gLinkName}}
          </a>
          <button type="button" class="icon-btn" data-action="uuid-clear" data-field="system.gLink">
            <i class="fa-solid fa-xmark"></i>
          </button>
        {{else}}
          <input
            type="text"
            name="system.gLink"
            value="{{system.gLink}}"
            data-action="uuid-drop"
            data-field="system.gLink"
          />
        {{/if}}
      </div>
    </div>

    {{!-- Влияние --}}
    <div class="form-group globalobject-influence">
      <label for="system.gRange" title="r: радиус (клетки), p: сила влияния">Влияние</label>
      <div class="form-fields influence-fields">
        <span class="influence-prefix" data-tooltip="Радиус (клетки)">r:</span>
        <input
          class="influence-input"
          type="number"
          name="system.gRange"
          value="{{system.gRange}}"
          data-dtype="Number"
          min="0"
          step="0.1"
          title="Радиус влияния (клетки)"
        />
        <span class="influence-sep">/</span>
        <span class="influence-prefix" data-tooltip="Сила влияния">p:</span>
        <input
          class="influence-input"
          type="number"
          name="system.gPower"
          value="{{system.gPower}}"
          data-dtype="Number"
          min="0"
          step="0.1"
          title="Сила влияния"
        />
      </div>
    </div>

    {{!-- Контейнер актёров (drag&drop сюда) --}}
    <div class="inventory-panel globalobject-actors-panel" data-action="gactors-drop">
      {{#if gActorsResolved.length}}
        <div class="inventory-list">
          {{#each gActorsResolved as |a|}}
            <div class="inventory-item-card rimworld-header" data-uuid="{{a.uuid}}">
              <div class="item-main">
                <div class="item-image">
                  <img
                    src="{{a.img}}"
                    title="{{a.name}}"
                    width="32"
                    height="32"
                  />
                </div>
                <div class="item-info">
                  <div class="item-name">{{a.name}}</div>
                </div>
              </div>
              <div class="globalobject-actor-type" title="Тип актора">{{a.typeLabel}}</div>
              <div class="item-controls">
                <button type="button" class="icon-btn" data-action="gactor-open" data-uuid="{{a.uuid}}" title="Открыть">
                  <i class="fa-solid fa-arrow-up-right-from-square"></i>
                </button>
                <button type="button" class="icon-btn" data-action="gactor-take" data-uuid="{{a.uuid}}" title="Достать">
                  <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>
                <button type="button" class="icon-btn" data-action="gactor-remove" data-uuid="{{a.uuid}}" title="Убрать">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>
          {{/each}}
        </div>
      {{else}}
        <div class="empty-inventory">
          <i class="fas fa-box-open"></i>
          <p><em>Тут пока пусто. Перетащите актёра сюда, чтобы добавить.</em></p>
        </div>
      {{/if}}
    </div>

  </section>
</form>
