# Исправления Token Pointer

## Описание проблем

### Баг 1: Ctrl+колёсико сбрасывает указатель
**Проблема**: При повороте токена с помощью Ctrl+колёсико указатель автоматически сбрасывался к направлению "токен + 90°".
**Ожидаемое поведение**: Указатель должен оставаться в том же направлении в мировых координатах.

### Баг 2: Shift+WASD поворачивает и токен, и указатель
**Проблема**: При нажатии Shift+WASD поворачивались и токен, и указатель одновременно.
**Ожидаемое поведение**: Должен поворачиваться только указатель.

### Баг 3: Ctrl+Z неправильно восстанавливает указатель
**Проблема**: При отмене движения через Ctrl+Z указатель поворачивался в направлении "обратного движения".
**Ожидаемое поведение**: Указатель должен вернуться к предыдущему направлению.

## Реализованные исправления

### 1. Исправление логики preUpdateToken

**Файл**: `module/helpers/token-pointer.mjs`
**Строки**: 605-675

**Изменения**:
- Добавлена проверка на чистый поворот токена (`hasRotation && noPosChange`)
- При чистом повороте токена указатель больше не обновляется
- Направление указателя обновляется только при движении токена
- При одновременном движении и повороте используется направление движения

```javascript
// Если есть только поворот токена (Ctrl+колёсико), НЕ обновляем направление указателя
if (hasRotation && noPosChange) {
  console.log('TokenPointer | Token rotation detected, preserving pointer direction');
  return; // Не обновляем tokenpointerDirection при чистом повороте токена
}
```

### 2. Добавление обработчиков Shift+WASD

**Файл**: `module/helpers/token-pointer.mjs`
**Строки**: 676-752

**Новые возможности**:
- `Shift+W`: Поворот указателя вверх (-90°)
- `Shift+A`: Поворот указателя влево (180°)
- `Shift+S`: Поворот указателя вниз (90°)
- `Shift+D`: Поворот указателя вправо (0°)
- `Ctrl+Shift+WASD`: Плавный поворот на 15° за нажатие

### 3. Добавление системы сохранения состояния для undo

**Файл**: `module/helpers/token-pointer.mjs`
**Строки**: 683-752, 626-636, 666-668, 688-690

**Новая функциональность**:
- Автоматическое сохранение истории позиций и направлений указателя
- Обнаружение undo операций по возвращению к сохранённым позициям
- Восстановление предыдущего направления указателя при undo
- Оптимизация памяти (сохранение максимум 50 состояний на токен)

**Особенности реализации**:
- Использование Map для хранения истории по tokenId
- Допуск 5 пикселей для поиска соответствующих позиций
- Очистка истории при удалении токенов

**Особенности реализации**:
- Используется capture-фаза событий для перехвата клавиш до Foundry VTT
- `event.preventDefault()` и `event.stopPropagation()` блокируют стандартную обработку
- Поддержка нескольких выбранных токенов
- Нормализация углов в диапазон [-180, 180]

## Тестирование

Для проверки исправлений запустите в консоли браузера:
```javascript
// Загрузите и выполните тестовый скрипт
fetch('/systems/spaceholder/test-pointer-fixes.js')
  .then(r => r.text())
  .then(eval);
```

### Ручное тестирование

1. **Тест Ctrl+колёсико**:
   - Выберите токен
   - Запомните направление указателя
   - Поверните токен с Ctrl+колёсико
   - Убедитесь что указатель остался в том же направлении

2. **Тест Shift+WASD**:
   - Выберите токен  
   - Нажмите Shift+W/A/S/D
   - Убедитесь что поворачивается только указатель, не токен

## Технические детали

### Логика сохранения направления указателя
При повороте токена указатель сохраняет своё абсолютное направление в мировых координатах, а не относительно токена.

### Перехват клавиатурных событий
Используется `addEventListener` с параметром `capture: true` для перехвата событий Shift+WASD до их обработки Foundry VTT.

### Совместимость
- Все изменения обратно совместимы
- Существующие токены продолжат работать как прежде
- Новая логика активируется только при соответствующих действиях

## Логирование

Добавлено детальное логирование для отладки:
- Определение поворота токена
- Обработка Shift+WASD
- Изменения направления указателя